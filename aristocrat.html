<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aristocrat Cipher Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 6s infinite;
        }
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        .content {
            padding: 30px;
        }
        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .control-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1em;
            margin-bottom: 5px;
        }
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .radio-option:hover {
            background-color: #f8f9fa;
        }
        .radio-option input[type="radio"] {
            margin: 0;
        }
        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
        }
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .keyword-guess {
            margin-top: 15px;
        }
        .keyword-input {
            padding: 8px 12px;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 1em;
            width: 200px;
            margin-right: 10px;
        }
        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .cipher-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            line-height: 1.8;
        }
        .cipher-text-line {
            display: flex;
            gap: 1px;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: flex-start;
            margin-bottom: 15px;
        }
        .cipher-pair {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1px;
        }
        .cipher-letter {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            background: #fff3cd;
            padding: 6px 4px;
            border-radius: 4px;
            min-width: 28px;
            text-align: center;
            border: 2px solid #ffc107;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .space-marker {
            width: 15px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            color: #6c757d;
        }
        .line-break {
            width: 100%;
            height: 10px;
        }
        .answer-box {
            width: 28px;
            height: 28px;
            border: 2px solid #3498db;
            border-radius: 4px;
            text-align: center;
            font-size: 0.95em;
            font-weight: bold;
            background: white;
            outline: none;
            transition: all 0.3s ease;
            margin-top: 2px;
        }
        .answer-box:focus {
            border-color: #2980b9;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }
        .freq-table {
            display: grid;
            grid-template-columns: repeat(26, 1fr);
            gap: 4px;
            margin-top: 15px;
            max-width: 100%;
            overflow-x: auto;
        }
        .freq-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 6px 3px;
            border: 1px solid #dee2e6;
            min-width: 35px;
        }
        .freq-cipher {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.95em;
            margin-bottom: 3px;
        }
        .freq-count {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 3px;
        }
        .freq-input {
            width: 26px;
            height: 22px;
            border: 1px solid #3498db;
            border-radius: 3px;
            text-align: center;
            font-size: 0.85em;
            font-weight: bold;
        }
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(0);
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .freq-table {
                grid-template-columns: repeat(13, 1fr);
                gap: 2px;
            }
            .freq-entry {
                min-width: 25px;
                padding: 4px 2px;
            }
            .freq-input {
                width: 20px;
                height: 18px;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Aristocrat Cipher Practice</h1>
        </div>
        
        <div class="content">
            <div id="statusMessage" class="status" style="display: none;"></div>
            
            <div class="section">
                <h2>Settings</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>Key Method:</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="random" name="keyMethod" value="random" checked>
                                <label for="random">Random</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="k1" name="keyMethod" value="k1">
                                <label for="k1">K1</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="k2" name="keyMethod" value="k2">
                                <label for="k2">K2</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="k3" name="keyMethod" value="k3">
                                <label for="k3">K3</label>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="checkbox-container">
                            <input type="checkbox" id="autofill" checked>
                            <label for="autofill">Auto-fill matching letters</label>
                        </div>
                        <div class="keyword-guess" id="keywordGuess" style="display: none;">
                            <label>Guess Keyword:</label>
                            <div style="margin-top: 5px;">
                                <input type="text" id="keywordInput" class="keyword-input" placeholder="Enter keyword">
                                <button class="btn-small" onclick="checkKeyword()">Check</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Cipher Text</h2>
                <div class="cipher-section" id="cipherSection">
                    <div class="loading">Loading bruh</div>
                </div>
            </div>

            <div class="section">
                <h2>Frequency Table</h2>
                <div class="freq-table" id="freqTable">
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn btn-primary" onclick="generateNewProblem()">New Problem</button>
                <button class="btn btn-success" onclick="checkAnswer()">Check Answer</button>
                <button class="btn btn-danger" onclick="showSolution()">Show Solution</button>
                <button class="btn btn-secondary" onclick="clearAnswer()">Clear Answer</button>
            </div>
        </div>
    </div>

    <script>
        let currentPlaintext = '';
        let currentCiphertext = '';
        let cipherMapping = {};
        let reverseMapping = {};
        let letterFrequencies = {};
        let currentKeyword = '';
        let currentMethod = '';
        let currentShift = 0;

        // Default quotes and words
        const quotes = [
            "The quick brown fox jumps over the lazy dog.",
            "To be or not to be, that is the question.",
            "All that glitters is not gold.",
            "A journey of a thousand miles begins with a single step.",
            "The only thing we have to fear is fear itself.",
            "In the beginning was the Word.",
            "Knowledge is power and power corrupts.",
            "Time heals all wounds but leaves ugly scars.",
            "The pen is mightier than the sword.",
            "Actions speak louder than words.",
            "Better late than never but never late is better.",
            "Where there is a will there is a way.",
            "Practice makes perfect but nobody is perfect.",
            "Life is what happens when you are busy making other plans.",
            "Fortune favors the bold and prepared mind.",
            "Rome was not built in a day.",
            "When in Rome do as the Romans do.",
            "The early bird catches the worm.",
            "A picture is worth a thousand words.",
            "Beauty is in the eye of the beholder."
        ];
        
        const words = [
            "ARGENTINA", "BUTTERFLY", "COMPUTER", "ELEPHANT", "FREEDOM",
            "GOVERNMENT", "HOSPITAL", "INTERNET", "JUSTICE", "KEYBOARD", 
            "LIBERTY", "MOUNTAIN", "NEIGHBOR", "OPPOSITE", "PATIENCE", 
            "QUESTION", "REPUBLIC", "STRENGTH", "TOGETHER", "UNIVERSE", 
            "VICTORY", "WONDERFUL", "EXAMPLE", "BUILDING", "CHANNEL",
            "DEMOCRACY", "EDUCATION", "FANTASTIC", "GREENHOUSE", "HARMONY"
        ];

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Rotate array elements to the right
        function rotateArray(arr, positions) {
            const len = arr.length;
            const normalizedPositions = positions % len;
            if (normalizedPositions === 0) return arr;
            
            return arr.slice(-normalizedPositions).concat(arr.slice(0, -normalizedPositions));
        }

        // Generate K1 cipher
        function generateK1Cipher(keyword) {
            const cipher = new Map();
            const plaintextAlphabet = [];
            
            // Add keyword letters first (no duplicates)
            for (const c of keyword.toUpperCase()) {
                if (/[A-Z]/.test(c) && !plaintextAlphabet.includes(c)) {
                    plaintextAlphabet.push(c);
                }
            }
            
            // Add remaining letters
            for (let c = 65; c <= 90; c++) { // A-Z
                const char = String.fromCharCode(c);
                if (!plaintextAlphabet.includes(char)) {
                    plaintextAlphabet.push(char);
                }
            }
            
            // Create standard cipher alphabet
            const cipherAlphabet = [];
            for (let c = 65; c <= 90; c++) {
                cipherAlphabet.push(String.fromCharCode(c));
            }
            
            // Apply rotation and fix self-mappings
            const rotatedCipher = rotateArray(cipherAlphabet, currentShift);
            fixSelfMappings(plaintextAlphabet, rotatedCipher);
            
            // Create the final mapping
            for (let i = 0; i < 26; i++) {
                cipher.set(plaintextAlphabet[i], rotatedCipher[i]);
            }
            
            return cipher;
        }

        // Generate K2 cipher
        function generateK2Cipher(keyword) {
            const cipher = new Map();
            const plaintextAlphabet = [];
            
            // Standard plaintext alphabet
            for (let c = 65; c <= 90; c++) {
                plaintextAlphabet.push(String.fromCharCode(c));
            }
            
            const cipherAlphabet = [];
            const used = new Set();
            
            // Add keyword letters first
            for (const c of keyword.toUpperCase()) {
                if (/[A-Z]/.test(c) && !used.has(c)) {
                    cipherAlphabet.push(c);
                    used.add(c);
                }
            }
            
            // Add remaining letters
            for (let c = 65; c <= 90; c++) {
                const char = String.fromCharCode(c);
                if (!used.has(char)) {
                    cipherAlphabet.push(char);
                }
            }
            
            // Apply rotation and fix self-mappings
            const rotatedCipher = rotateArray(cipherAlphabet, currentShift);
            fixSelfMappings(plaintextAlphabet, rotatedCipher);
            
            // Create the final mapping
            for (let i = 0; i < 26; i++) {
                cipher.set(plaintextAlphabet[i], rotatedCipher[i]);
            }
            
            return cipher;
        }

        // Generate K3 cipher
        function generateK3Cipher(keyword) {
            const cipher = new Map();
            const plaintextAlphabet = [];
            const usedLetters = new Set();
            
            // Add keyword letters first
            for (const c of keyword.toUpperCase()) {
                if (/[A-Z]/.test(c) && !usedLetters.has(c)) {
                    plaintextAlphabet.push(c);
                    usedLetters.add(c);
                }
            }
            
            // Add remaining letters
            for (let c = 65; c <= 90; c++) {
                const char = String.fromCharCode(c);
                if (!usedLetters.has(char)) {
                    plaintextAlphabet.push(char);
                }
            }
            
            // For K3, cipher alphabet is plaintext alphabet REVERSED
            const cipherAlphabet = [...plaintextAlphabet].reverse();
            
            // Apply rotation and fix self-mappings
            const rotatedCipher = rotateArray(cipherAlphabet, currentShift);
            fixSelfMappings(plaintextAlphabet, rotatedCipher);
            
            // Create the final mapping
            for (let i = 0; i < 26; i++) {
                cipher.set(plaintextAlphabet[i], rotatedCipher[i]);
            }
            
            return cipher;
        }

        function fixSelfMappings(plaintext, cipher) {
            // Fix self-mappings by swapping
            for (let i = 0; i < 26; i++) {
                if (plaintext[i] === cipher[i]) {
                    // Find a position that doesn't have self-mapping
                    for (let j = 0; j < 26; j++) {
                        if (i !== j && plaintext[j] !== cipher[j]) {
                            // Swap them
                            const temp = cipher[j];
                            cipher[j] = cipher[i];
                            cipher[i] = temp;
                            break;
                        }
                    }
                }
            }
            
            // Final cleanup pass
            let needFixing;
            do {
                needFixing = false;
                for (let i = 0; i < 26; i++) {
                    if (plaintext[i] === cipher[i]) {
                        needFixing = true;
                        for (let j = 0; j < 26; j++) {
                            if (i !== j && 
                                plaintext[j] !== cipher[i] && 
                                plaintext[i] !== cipher[j]) {
                                const temp = cipher[j];
                                cipher[j] = cipher[i];
                                cipher[i] = temp;
                                break;
                            }
                        }
                    }
                }
            } while (needFixing);
        }

        function generateRandomMapping() {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const shuffled = alphabet.split('').sort(() => Math.random() - 0.5);
            
            // Ensure no self-mapping
            for (let i = 0; i < 26; i++) {
                if (alphabet[i] === shuffled[i]) {
                    let swapIndex = (i + 1) % 26;
                    while (swapIndex === i || alphabet[swapIndex] === shuffled[swapIndex]) {
                        swapIndex = (swapIndex + 1) % 26;
                    }
                    [shuffled[i], shuffled[swapIndex]] = [shuffled[swapIndex], shuffled[i]];
                }
            }
            
            const mapping = new Map();
            for (let i = 0; i < 26; i++) {
                mapping.set(alphabet[i], shuffled[i]);
            }
            return mapping;
        }

        function encryptText(text, mapping) {
            return text.toUpperCase().split('').map(char => {
                if (char.match(/[A-Z]/)) {
                    return mapping.get(char);
                }
                return char;
            }).join('');
        }

        function calculateFrequencies(text) {
            const frequencies = {};
            const letters = text.replace(/[^A-Z]/g, '');
            
            for (const letter of letters) {
                frequencies[letter] = (frequencies[letter] || 0) + 1;
            }
            
            return frequencies;
        }

        function getSelectedKeyMethod() {
            const radios = document.querySelectorAll('input[name="keyMethod"]');
            for (let radio of radios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'random';
        }

        function generateNewProblem() {
            // Select random quote
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            currentPlaintext = quote.replace(/[^a-zA-Z\s]/g, '').toUpperCase();
            
            // Generate cipher mapping based on selected method
            const method = getSelectedKeyMethod();
            currentMethod = method;
            currentShift = Math.floor(Math.random() * 25) + 1; // Random shift 1-25
            
            if (method === 'random') {
                cipherMapping = generateRandomMapping();
                currentKeyword = '';
            } else {
                // Select random keyword
                const keyword = words[Math.floor(Math.random() * words.length)];
                currentKeyword = keyword;
                
                if (method === 'k1') {
                    cipherMapping = generateK1Cipher(keyword);
                } else if (method === 'k2') {
                    cipherMapping = generateK2Cipher(keyword);
                } else if (method === 'k3') {
                    cipherMapping = generateK3Cipher(keyword);
                }
            }
            
            // Create reverse mapping
            reverseMapping = {};
            for (let [plain, cipher] of cipherMapping) {
                reverseMapping[cipher] = plain;
            }
            
            // Encrypt the text
            currentCiphertext = encryptText(currentPlaintext, cipherMapping);
            
            // Calculate frequencies
            letterFrequencies = calculateFrequencies(currentCiphertext);
            
            // Show/hide keyword guess section
            const keywordGuessEl = document.getElementById('keywordGuess');
            if (method !== 'random') {
                keywordGuessEl.style.display = 'block';
                document.getElementById('keywordInput').value = '';
            } else {
                keywordGuessEl.style.display = 'none';
            }
            
            // Display the cipher
            displayCipher();
            displayFrequencyTable();
            
            showStatus('New problem generated!', 'success');
        }

        function displayCipher() {
            const container = document.getElementById('cipherSection');
            container.innerHTML = '';
            
            const words = currentCiphertext.split(/\s+/);
            let currentLine = document.createElement('div');
            currentLine.className = 'cipher-text-line';
            
            for (let wordIndex = 0; wordIndex < words.length; wordIndex++) {
                const word = words[wordIndex];
                
                // Add space marker if not first word in line
                if (currentLine.children.length > 0) {
                    const spaceMarker = document.createElement('div');
                    spaceMarker.className = 'space-marker';
                    spaceMarker.textContent = '|';
                    currentLine.appendChild(spaceMarker);
                }
                
                // Add each letter of the word
                for (let i = 0; i < word.length; i++) {
                    const letter = word[i];
                    if (letter.match(/[A-Z]/)) {
                        const pair = document.createElement('div');
                        pair.className = 'cipher-pair';
                        
                        const cipherLetter = document.createElement('div');
                        cipherLetter.className = 'cipher-letter';
                        cipherLetter.textContent = letter;
                        
                        const answerBox = document.createElement('input');
                        answerBox.type = 'text';
                        answerBox.className = 'answer-box';
                        answerBox.maxLength = 1;
                        answerBox.dataset.cipher = letter;
                        answerBox.addEventListener('input', handleAnswerInput);
                        answerBox.addEventListener('keydown', handleKeyNavigation);
                        
                        pair.appendChild(cipherLetter);
                        pair.appendChild(answerBox);
                        currentLine.appendChild(pair);
                    }
                }
                
                // Check if we need to start a new line (every 10-12 words approximately)
                if (wordIndex > 0 && wordIndex % 10 === 0) {
                    container.appendChild(currentLine);
                    currentLine = document.createElement('div');
                    currentLine.className = 'cipher-text-line';
                }
            }
            
            // Add the last line if it has content
            if (currentLine.children.length > 0) {
                container.appendChild(currentLine);
            }
        }

        function displayFrequencyTable() {
            const container = document.getElementById('freqTable');
            container.innerHTML = '';
            
            // Get all cipher letters A-Z and sort by frequency
            const sortedLetters = Object.keys(letterFrequencies)
                .sort((a, b) => letterFrequencies[b] - letterFrequencies[a]);
            
            // Add entries for letters that appear in cipher
            sortedLetters.forEach(letter => {
                const entry = document.createElement('div');
                entry.className = 'freq-entry';
                
                const cipherDiv = document.createElement('div');
                cipherDiv.className = 'freq-cipher';
                cipherDiv.textContent = letter;
                
                const countDiv = document.createElement('div');
                countDiv.className = 'freq-count';
                countDiv.textContent = letterFrequencies[letter];
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'freq-input';
                input.maxLength = 1;
                input.dataset.cipher = letter;
                input.addEventListener('input', handleFreqInput);
                
                entry.appendChild(cipherDiv);
                entry.appendChild(countDiv);
                entry.appendChild(input);
                container.appendChild(entry);
            });
        }

        function handleAnswerInput(event) {
            const input = event.target;
            const value = input.value.toUpperCase();
            
            if (value && value.match(/[A-Z]/)) {
                input.value = value;
                
                // Auto-fill if enabled
                if (document.getElementById('autofill').checked) {
                    const cipherLetter = input.dataset.cipher;
                    fillMatchingLetters(cipherLetter, value);
                }
            } else {
                input.value = '';
            }
        }

        function handleFreqInput(event) {
            const input = event.target;
            const value = input.value.toUpperCase();
            
            if (value && value.match(/[A-Z]/)) {
                input.value = value;
                
                // Auto-fill cipher if enabled
                if (document.getElementById('autofill').checked) {
                    const cipherLetter = input.dataset.cipher;
                    fillMatchingLetters(cipherLetter, value);
                }
            } else {
                input.value = '';
            }
        }

        function fillMatchingLetters(cipherLetter, plainLetter) {
            // Fill all cipher inputs
            const cipherInputs = document.querySelectorAll(`.answer-box[data-cipher="${cipherLetter}"]`);
            cipherInputs.forEach(input => {
                input.value = plainLetter;
            });
            
            // Fill frequency table input
            const freqInput = document.querySelector(`.freq-input[data-cipher="${cipherLetter}"]`);
            if (freqInput) {
                freqInput.value = plainLetter;
            }
        }

        function handleKeyNavigation(event) {
            if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                const inputs = Array.from(document.querySelectorAll('.answer-box'));
                const currentIndex = inputs.indexOf(event.target);
                
                if (event.key === 'ArrowRight' && currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                } else if (event.key === 'ArrowLeft' && currentIndex > 0) {
                    inputs[currentIndex - 1].focus();
                }
            }
        }

        function checkAnswer() {
            const inputs = document.querySelectorAll('.answer-box');
            let correct = 0;
            let total = 0;
            
            inputs.forEach(input => {
                const cipherLetter = input.dataset.cipher;
                const userAnswer = input.value.toUpperCase();
                const correctAnswer = reverseMapping[cipherLetter];
                
                total++;
                if (userAnswer === correctAnswer) {
                    correct++;
                    input.style.backgroundColor = '#d4edda';
                    input.style.borderColor = '#28a745';
                } else if (userAnswer) {
                    input.style.backgroundColor = '#f8d7da';
                    input.style.borderColor = '#dc3545';
                } else {
                    input.style.backgroundColor = 'white';
                    input.style.borderColor = '#3498db';
                }
            });
            
            const percentage = Math.round((correct / total) * 100);
            let message = `${correct}/${total} correct (${percentage}%)`;
            let type = 'warning';
            
            if (percentage === 100) {
                message += ' - Perfect!';
                type = 'success';
            } else if (percentage >= 80) {
                message += ' - Great job!';
                type = 'success';
            } else if (percentage >= 60) {
                message += ' - Good progress!';
            } else {
                message += ' - Keep trying!';
                type = 'error';
            }
            
            showStatus(message, type);
        }

        function showSolution() {
            const inputs = document.querySelectorAll('.answer-box');
            inputs.forEach(input => {
                const cipherLetter = input.dataset.cipher;
                const correctAnswer = reverseMapping[cipherLetter];
                input.value = correctAnswer;
                input.style.backgroundColor = '#d1ecf1';
                input.style.borderColor = '#17a2b8';
            });
            
            const freqInputs = document.querySelectorAll('.freq-input');
            freqInputs.forEach(input => {
                const cipherLetter = input.dataset.cipher;
                const correctAnswer = reverseMapping[cipherLetter];
                input.value = correctAnswer;
            });
            
            showStatus('Solution revealed!', 'success');
        }

        function clearAnswer() {
            const inputs = document.querySelectorAll('.answer-box, .freq-input');
            inputs.forEach(input => {
                input.value = '';
                input.style.backgroundColor = 'white';
                input.style.borderColor = input.classList.contains('answer-box') ? '#3498db' : '#3498db';
            });
            
            showStatus('Answer cleared!', 'warning');
        }

        function checkKeyword() {
            const userKeyword = document.getElementById('keywordInput').value.toUpperCase().trim();
            
            if (!userKeyword) {
                showStatus('Please enter a keyword!', 'error');
                return;
            }
            
            if (userKeyword === currentKeyword) {
                showStatus('Correct keyword!', 'success');
                document.getElementById('keywordInput').style.backgroundColor = '#d4edda';
                document.getElementById('keywordInput').style.borderColor = '#28a745';
            } else {
                showStatus('Incorrect keyword. Try again!', 'error');
                document.getElementById('keywordInput').style.backgroundColor = '#f8d7da';
                document.getElementById('keywordInput').style.borderColor = '#dc3545';
            }
        }
        
        // Initialize when page loads - THIS IS THE FIX!
        document.addEventListener('DOMContentLoaded', function() {
            // Generate first problem immediately
            generateNewProblem();
            
            // Add event listeners for radio buttons
            const radios = document.querySelectorAll('input[name="keyMethod"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const keywordGuessEl = document.getElementById('keywordGuess');
                    if (radio.value !== 'random') {
                        keywordGuessEl.style.display = 'block';
                    } else {
                        keywordGuessEl.style.display = 'none';
                    }
                });
            });
        });
